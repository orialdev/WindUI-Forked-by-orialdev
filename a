-- src/init.lua
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local LocalPlayer = game:GetService("Players").LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local Library = {
    Themes = {
        Default = {
            BackgroundColor = Color3.fromRGB(220, 224, 230),
            SidebarColor = Color3.fromRGB(230, 235, 240),
            ElementColor = Color3.fromRGB(240, 245, 250),
            TextColor = Color3.fromRGB(30, 30, 30),
            AccentColor = Color3.fromRGB(0, 85, 255),
        }
    },
    ActiveTheme = "Default"
}

-- Utility for rounded corners and simple tweens
function Library:Create(class, properties)
    local instance = Instance.new(class)
    for k, v in pairs(properties) do
        instance[k] = v
    end
    return instance
end

function Library:MakeRound(guiObject, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius or 6)
    corner.Parent = guiObject
    return corner
end

-- MAIN WINDOW FUNCTION
function Library:CreateWindow(options)
    local windowTitle = options.Title or "UI Library"
    local subTitle = options.SubTitle or ""

    local ScreenGui = self:Create("ScreenGui", {
        Name = "FluentUI",
        Parent = RunService:IsStudio() and game.Players.LocalPlayer:WaitForChild("PlayerGui") or game.CoreGui,
        IgnoreGuiInset = true,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })

    -- Main Container (Blur/Acrylic simulation usually done with ImageLabels, simple Color here)
    local MainFrame = self:Create("Frame", {
        Name = "MainFrame",
        Parent = ScreenGui,
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.fromScale(0.5, 0.5),
        Size = UDim2.fromOffset(600, 450),
        BackgroundColor3 = self.Themes[self.ActiveTheme].BackgroundColor,
        BorderSizePixel = 0
    })
    self:MakeRound(MainFrame, 10)
    
    -- Dragging Logic
    local dragToggle, dragStart, startPos
    local dragInput
    
    local function update(input)
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    
    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragToggle = true
            dragStart = input.Position
            startPos = MainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragToggle = false
                end
            end)
        end
    end)
    
    MainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragToggle then
            update(input)
        end
    end)

    -- TOP HEADER
    local HeaderFrame = self:Create("Frame", {
        Name = "Header",
        Parent = MainFrame,
        Size = UDim2.new(1, 0, 0, 60),
        BackgroundTransparency = 1
    })

    local TitleLabel = self:Create("TextLabel", {
        Parent = HeaderFrame,
        Text = windowTitle,
        Font = Enum.Font.GothamBold,
        TextSize = 24,
        TextColor3 = self.Themes[self.ActiveTheme].TextColor,
        Size = UDim2.new(0, 200, 1, -20),
        Position = UDim2.new(0, 20, 0, 5),
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local SubLabel = self:Create("TextLabel", {
        Parent = HeaderFrame,
        Text = subTitle,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextColor3 = Color3.fromRGB(150, 150, 150),
        Size = UDim2.new(0, 200, 0, 20),
        Position = UDim2.new(0, 20, 0, 32),
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left
    })

    -- SEARCH BAR (Visual only)
    local SearchBar = self:Create("Frame", {
        Parent = HeaderFrame,
        Size = UDim2.new(0, 200, 0, 35),
        Position = UDim2.new(0.5, -30, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = Color3.fromRGB(240, 240, 240)
    })
    self:MakeRound(SearchBar, 6)
    
    local SearchIcon = self:Create("ImageLabel", {
        Parent = SearchBar,
        Image = "rbxassetid://7072719692", -- Search Icon
        Size = UDim2.fromOffset(18, 18),
        Position = UDim2.fromOffset(10, 8),
        BackgroundTransparency = 1,
        ImageColor3 = Color3.fromRGB(150,150,150)
    })
    
    local SearchText = self:Create("TextBox", {
        Parent = SearchBar,
        Size = UDim2.new(1, -40, 1, 0),
        Position = UDim2.fromOffset(35, 0),
        BackgroundTransparency = 1,
        PlaceholderText = "Search",
        Text = "",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left
    })

    -- CONTENT CONTAINERS
    local Sidebar = self:Create("ScrollingFrame", {
        Parent = MainFrame,
        Size = UDim2.new(0, 180, 1, -70),
        Position = UDim2.new(1, -190, 0, 60),
        BackgroundColor3 = self.Themes[self.ActiveTheme].SidebarColor,
        ScrollBarThickness = 2,
        BorderSizePixel = 0
    })
    self:MakeRound(Sidebar, 8)

    local TabContainer = self:Create("Frame", {
        Parent = MainFrame,
        Size = UDim2.new(1, -210, 1, -70),
        Position = UDim2.new(0, 15, 0, 60),
        BackgroundTransparency = 1
    })
    
    local UIPageLayout = Instance.new("UIPageLayout")
    UIPageLayout.Parent = TabContainer
    UIPageLayout.SortOrder = Enum.SortOrder.LayoutOrder
    UIPageLayout.TweenTime = 0.3
    UIPageLayout.EasingStyle = Enum.EasingStyle.Quint
    
    -- TABS LOGIC
    local Tabs = {}
    
    function Tabs:AddTab(config)
        local tabName = config.Title or "Tab"
        local icon = config.Icon or ""
        
        -- Create container for elements
        local TabPage = Library:Create("ScrollingFrame", {
            Name = tabName,
            Parent = TabContainer,
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            ScrollBarThickness = 2,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y
        })
        
        local TabListLayout = Instance.new("UIListLayout")
        TabListLayout.Parent = TabPage
        TabListLayout.Padding = UDim.new(0, 8)
        TabListLayout.SortOrder = Enum.SortOrder.LayoutOrder
        
        -- Create Sidebar Button
        local TabBtn = Library:Create("TextButton", {
            Parent = Sidebar,
            Size = UDim2.new(0.9, 0, 0, 32),
            BackgroundColor3 = Color3.fromRGB(255,255,255),
            BackgroundTransparency = 1, -- Starts transparent
            Text = "",
            AutoButtonColor = false
        })
        Library:MakeRound(TabBtn, 6)

        -- Icon
        if icon ~= "" then
            Library:Create("ImageLabel", {
                Parent = TabBtn,
                Image = icon,
                Size = UDim2.fromOffset(20,20),
                Position = UDim2.fromOffset(10,6),
                BackgroundTransparency = 1,
                ImageColor3 = Color3.fromRGB(100,100,100)
            })
        end

        local TabLabel = Library:Create("TextLabel", {
            Parent = TabBtn,
            Text = tabName,
            Font = Enum.Font.GothamMedium,
            TextSize = 14,
            TextColor3 = Color3.fromRGB(100,100,100),
            BackgroundTransparency = 1,
            Size = UDim2.new(1, -40, 1, 0),
            Position = UDim2.fromOffset(40, 0),
            TextXAlignment = Enum.TextXAlignment.Left
        })

        -- Activate Function
        TabBtn.MouseButton1Click:Connect(function()
            -- Reset others
            for _, c in pairs(Sidebar:GetChildren()) do
                if c:IsA("TextButton") then
                    TweenService:Create(c, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
                    TweenService:Create(c.TextLabel, TweenInfo.new(0.2), {TextColor3 = Color3.fromRGB(100,100,100)}):Play()
                end
            end
            -- Highlight selected
            TweenService:Create(TabBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
            TweenService:Create(TabLabel, TweenInfo.new(0.2), {TextColor3 = Color3.fromRGB(0,0,0)}):Play()
            
            UIPageLayout:JumpTo(TabPage)
        end)

        -- Handle elements
        local Elements = {}

        -- [[ TOGGLE COMPONENT ]]
        function Elements:AddToggle(config)
            local tName = config.Title or "Toggle"
            local tCallback = config.Callback or function() end
            local tState = config.Default or false

            local Frame = Library:Create("TextButton", {
                Parent = TabPage,
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundColor3 = Library.Themes.Default.ElementColor,
                Text = "",
                AutoButtonColor = false
            })
            Library:MakeRound(Frame, 6)

            Library:Create("TextLabel", {
                Parent = Frame,
                Text = tName,
                Font = Enum.Font.GothamMedium,
                TextSize = 14,
                TextColor3 = Color3.fromRGB(30,30,30),
                Size = UDim2.new(1, -50, 1, 0),
                Position = UDim2.fromOffset(45, 0), -- Room for checkbox
                BackgroundTransparency = 1,
                TextXAlignment = Enum.TextXAlignment.Left
            })

            local CheckBox = Library:Create("Frame", {
                Parent = Frame,
                Size = UDim2.fromOffset(22, 22),
                Position = UDim2.fromOffset(10, 10),
                BackgroundColor3 = tState and Color3.fromRGB(40,40,40) or Color3.fromRGB(255,255,255)
            })
            Library:MakeRound(CheckBox, 5)

            local CheckIcon = Library:Create("ImageLabel", {
                Parent = CheckBox,
                Image = "rbxassetid://3944680095", -- Checkmark
                Size = UDim2.fromOffset(16, 16),
                Position = UDim2.fromOffset(3,3),
                ImageColor3 = Color3.fromRGB(255,255,255),
                BackgroundTransparency = 1,
                ImageTransparency = tState and 0 or 1
            })

            Frame.MouseButton1Click:Connect(function()
                tState = not tState
                
                -- Animate
                if tState then
                    TweenService:Create(CheckBox, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(40,40,40)}):Play()
                    TweenService:Create(CheckIcon, TweenInfo.new(0.2), {ImageTransparency = 0}):Play()
                else
                    TweenService:Create(CheckBox, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255,255,255)}):Play()
                    TweenService:Create(CheckIcon, TweenInfo.new(0.2), {ImageTransparency = 1}):Play()
                end
                
                tCallback(tState)
            end)
        end
        
        -- [[ SLIDER COMPONENT ]]
        function Elements:AddSlider(config)
            local sName = config.Title or "Slider"
            local min = config.Min or 0
            local max = config.Max or 100
            local default = config.Default or min
            local callback = config.Callback or function() end

            local Frame = Library:Create("Frame", {
                Parent = TabPage,
                Size = UDim2.new(1, 0, 0, 50),
                BackgroundColor3 = Library.Themes.Default.ElementColor
            })
            Library:MakeRound(Frame, 6)

            Library:Create("TextLabel", {
                Parent = Frame,
                Text = sName,
                Font = Enum.Font.GothamMedium,
                TextSize = 14,
                TextColor3 = Color3.fromRGB(30,30,30),
                Size = UDim2.new(0.5, 0, 0, 50),
                Position = UDim2.new(0, 15, 0, 0),
                BackgroundTransparency = 1,
                TextXAlignment = Enum.TextXAlignment.Left
            })

            local ValueLabel = Library:Create("TextLabel", {
                Parent = Frame,
                Text = tostring(default),
                Font = Enum.Font.Gotham,
                TextSize = 14,
                TextColor3 = Color3.fromRGB(100,100,100),
                Size = UDim2.new(0, 50, 0, 50),
                Position = UDim2.new(0, 160, 0, 0), -- Roughly middle-left
                BackgroundTransparency = 1,
                TextXAlignment = Enum.TextXAlignment.Right
            })

            local SliderBar = Library:Create("Frame", {
                Parent = Frame,
                Size = UDim2.new(0, 120, 0, 4),
                Position = UDim2.new(1, -140, 0.5, -2),
                BackgroundColor3 = Color3.fromRGB(200,200,200)
            })
            Library:MakeRound(SliderBar, 2)

            local Fill = Library:Create("Frame", {
                Parent = SliderBar,
                Size = UDim2.new((default - min)/(max - min), 0, 1, 0),
                BackgroundColor3 = Color3.fromRGB(40,40,40)
            })
            Library:MakeRound(Fill, 2)

            local Handle = Library:Create("ImageButton", {
                Parent = Fill,
                Size = UDim2.fromOffset(14, 14),
                Position = UDim2.new(1, -5, 0.5, -7),
                BackgroundColor3 = Color3.fromRGB(255,255,255)
            })
            Library:MakeRound(Handle, 7)
            
            local dragging = false
            
            Handle.MouseButton1Down:Connect(function() dragging = true end)
            UserInputService.InputEnded:Connect(function(input) 
                if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end 
            end)
            
            UserInputService.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    local percent = math.clamp((input.Position.X - SliderBar.AbsolutePosition.X) / SliderBar.AbsoluteSize.X, 0, 1)
                    local value = math.floor(min + (max - min) * percent)
                    
                    TweenService:Create(Fill, TweenInfo.new(0.05), {Size = UDim2.new(percent, 0, 1, 0)}):Play()
                    ValueLabel.Text = tostring(value)
                    callback(value)
                end
            end)
        end
        
        -- [[ BUTTON COMPONENT ]]
        function Elements:AddButton(config)
             local bName = config.Title or "Button"
             local bCallback = config.Callback or function() end
             
             local Btn = Library:Create("TextButton", {
                 Parent = TabPage,
                 Size = UDim2.new(1, 0, 0, 42),
                 BackgroundColor3 = Library.Themes.Default.ElementColor,
                 Text = "   " .. bName,
                 Font = Enum.Font.GothamMedium,
                 TextColor3 = Color3.fromRGB(30,30,30),
                 TextSize = 14,
                 TextXAlignment = Enum.TextXAlignment.Left,
                 AutoButtonColor = true
             })
             Library:MakeRound(Btn, 6)
             
             -- Arrow indicator
             Library:Create("ImageLabel", {
                 Parent = Btn,
                 Image = "rbxassetid://7072706796", -- Chevron right
                 Size = UDim2.fromOffset(16,16),
                 Position = UDim2.new(1, -26, 0.5, -8),
                 BackgroundTransparency = 1,
                 ImageColor3 = Color3.fromRGB(150,150,150)
             })
             
             Btn.MouseButton1Click:Connect(bCallback)
        end
        
        -- [[ PARAGRAPH COMPONENT ]]
        function Elements:AddParagraph(config)
             local pTitle = config.Title or "Paragraph"
             local pContent = config.Content or "Content here..."
             
             local Container = Library:Create("Frame", {
                 Parent = TabPage,
                 Size = UDim2.new(1,0,0,0), -- Will autosize
                 BackgroundColor3 = Library.Themes.Default.ElementColor,
             })
             Library:MakeRound(Container, 6)
             
             local TitleLab = Library:Create("TextLabel", {
                 Parent = Container,
                 Text = pTitle,
                 Font = Enum.Font.GothamBold,
                 TextSize = 14,
                 TextColor3 = Color3.fromRGB(30,30,30),
                 Size = UDim2.new(1, -20, 0, 25),
                 Position = UDim2.new(0, 10, 0, 5),
                 BackgroundTransparency = 1,
                 TextXAlignment = Enum.TextXAlignment.Left
             })
             
             local ContentLab = Library:Create("TextLabel", {
                 Parent = Container,
                 Text = pContent,
                 Font = Enum.Font.Gotham,
                 TextSize = 13,
                 TextColor3 = Color3.fromRGB(100,100,100),
                 Size = UDim2.new(1, -20, 0, 0),
                 Position = UDim2.new(0, 10, 0, 30),
                 BackgroundTransparency = 1,
                 TextXAlignment = Enum.TextXAlignment.Left,
                 TextWrapped = true,
                 AutomaticSize = Enum.AutomaticSize.Y
             })
             
             -- Adjust container height based on text
             Container.AutomaticSize = Enum.AutomaticSize.Y
             
             -- Simple padding at bottom via blank frame or constraint (simplifying here)
             Library:Create("Frame",{Parent = Container, Size = UDim2.new(1,0,0,10), BackgroundTransparency=1, Position = UDim2.new(0,0,1,0), LayoutOrder=100})
        end

        return Elements
    end

    -- Initial Tab Select (To trigger UI setup)
    if #Sidebar:GetChildren() > 0 then
         -- Auto select logic if needed
    end

    return Tabs
end

return Library
